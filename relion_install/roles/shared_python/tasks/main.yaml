# Install Python-related modules, such as Anaconda and mpi4py
---
- name: Set up Python directory
  file:
    state: directory
    path: "{{ python_dir }}"

- name: Display message
  debug:
    msg: "Anaconda for Python 2.7 will be installed at {{ python_dir }}. An installer will be downloaded to the download directory there and then run. Output generated by the installer will be also be located in the download directory. If installation fails, please check for error messages there."

- name: Check if Anaconda installation exists
  stat:
    path: "{{ conda_bin }}"
  register: conda_bin_path

- name: Create download directory if it doesn't exist
  file: path={{ download_dir }} state=directory

- name: Download Anaconda for Python 2.7 installer
  get_url:
    url: "{{ conda_dl_link }}"
    dest: "{{ download_dir }}"
    checksum: "{{ conda_dl_checksum }}"
  when: not conda_bin_path.stat.exists

# run Anaconda installer in batch mode (no manual input)
- name: Run Anaconda installer
  shell: "bash {{ conda_installer }} -b -p {{ conda_install_dir }} > anaconda_install.out 2> anaconda_install.err"
  args:
    chdir: "{{ download_dir }}"
  when: not conda_bin_path.stat.exists

# TESTING: See if pip updates if updated via apt
- name: Try to update pip
  apt: name={{ item }} state=latest update_cache=yes
  with_items:
    - python-pip
    - python-dev
    - build-essential
  become: yes

# requires pip to have been installed by Anaconda 
- name: Install Python packages mpi4py and simplejson
  pip:
    name: "{{ item }}"
    state: latest
  with_items:
    - mpi4py
    - simplejson
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ conda_bin }}"
  ignore_errors: yes
# the ignore_errors is necessary because sometimes the pip module successfully
# installs but reports failed to ansible because the pip version is not the latest.
# I believe this is a bug with ansible, so I've included this temporary workaround
